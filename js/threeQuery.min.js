var threeQuery=function(){this.global={};this.global.camera;this.global.world;this.global.canvasDom;this.global.canvasContainerDom=document.body;this.global.renderer;this.global.vrEffect;this.getWorldWidth=function(){return this.global.canvasContainerDom==document.body?window.innerWidth:this.global.canvasContainerDom.offsetWidth};this.getWorldHeight=function(){return this.global.canvasContainerDom==document.body?window.innerHeight:this.global.canvasContainerDom.offsetHeight};this.rightButtonEvent=function(a){this.global.canvasContainerDom.oncontextmenu=function(e){if(a){a(e)}e.preventDefault()}};this.resize=function(){var a=this.getWorldWidth();var b=this.getWorldHeight();if(this.global.settings.camera.type=="PerspectiveCamera"){this.global.camera.aspect=a/b;this.global.camera.updateProjectionMatrix()}else{this.global.camera.left=-a/2;this.global.camera.right=a/2;this.global.camera.top=b/2;this.global.camera.bottom=-b/2}this.global.renderer.setSize(a,b);if($$.global.settings.vr&&$$.global.vrEffect){this.global.vrEffect.setSize(a,b)}};this.setCommonCSS=function(){document.write("<style>*{margin:0;padding:0} body{overflow:hidden}</style>")};this.createWorld=function(a){var b=new THREE.Scene();if(!this.global.world){this.global.world=b}return b};this.createFog=function(a,b){a=a||{color:0xffffff,concentration:0.01};var c=b||this.global.world;c.fog=new THREE.FogExp2(a.color||0,a.concentration||0);return c.fog};this.createRenderer=function(a){a=this.extends({},[this.global.settings.render,a]);var b=new THREE.WebGLRenderer(a);b.setSize(this.getWorldWidth(),this.getWorldHeight());if(!this.global.renderer){this.global.renderer=b;this.global.canvasContainerDom.appendChild(this.global.renderer.domElement);if($$.global.settings.vr){this.global.vrEffect=new THREE.StereoEffect(this.global.renderer)}this.global.canvasDom=this.global.renderer.domElement}return b};this.createCamera=function(a){var b;var a=this.extends({},[this.global.settings.camera,a]);if(a.type!="OrthographicCamera"){b=new THREE.PerspectiveCamera(a.fov,a.aspect,a.near,a.far)}else{b=new THREE.OrthographicCamera(a.left,a.right,a.top,a.bottom,a.near,a.far)}if(!this.global.camera){this.global.camera=b}return b};this.init=function(a,b,c){this.setCommonCSS();this.createWorld(a);this.createRenderer(b);this.createCamera(c);this.addEventListener();return[this.global.world,this.global.renderer,this.global.camera]};this.addEventListener=function(){function onDocumentMouseMove(a){a.preventDefault();$$.global.mouse.x=(a.clientX/$$.getWorldWidth())*2-1;$$.global.mouse.y=-(a.clientY/$$.getWorldHeight())*2+1;if($$.global.selectedObj&&$$.global.selectedObj.object.onDrag&&$$.global.isDown){$$.global.selectedObj.object.onDrag($$.global.selectedObj)}}function onDocumentMouseClick(a){if($$.global.selectedObj&&$$.global.selectedObj.object.onClick&&$$.global.selectedObj.object.isDown==true){$$.global.selectedObj.object.isDown=false;$$.global.selectedObj.object.onClick($$.global.selectedObj,a)}if($$.global.centerSelectedObj&&$$.global.centerSelectedObj.object.onCenterClick&&$$.global.centerSelectedObj.object.isCenterDown==true){$$.global.centerSelectedObj.object.isCenterDown=false;$$.global.centerSelectedObj.object.onCenterClick($$.global.centerSelectedObj,a)}}function onMouseDownOrTouchStart(a){if(a.type=="touchstart"){$$.global.mouse.x=(a.targetTouches[0].clientX/$$.getWorldWidth())*2-1;$$.global.mouse.y=-(a.targetTouches[0].clientY/$$.getWorldHeight())*2+1;updateMouseRaycaster(true)}$$.global.isDown=true;if($$.global.selectedObj&&$$.global.selectedObj.object){$$.global.selectedObj.object.isDown=true}if($$.global.selectedObj&&$$.global.selectedObj.object.onDown){$$.global.selectedObj.object.onDown($$.global.selectedObj,a)}$$.global.isCenterDown=true;if($$.global.centerSelectedObj&&$$.global.centerSelectedObj.object){$$.global.centerSelectedObj.object.isCenterDown=true}if($$.global.centerSelectedObj&&$$.global.centerSelectedObj.object.onCenterDown){$$.global.centerSelectedObj.object.onCenterDown($$.global.centerSelectedObj,a)}}function onMouseUpOrTouchEnd(a){$$.global.isDown=false;if($$.global.selectedObj&&$$.global.selectedObj.object.onUp&&$$.global.selectedObj.object.isDown==true){$$.global.selectedObj.object.onUp($$.global.selectedObj,a)}$$.global.isCenterDown=false;if($$.global.centerSelectedObj&&$$.global.centerSelectedObj.object.onCenterUp&&$$.global.centerSelectedObj.object.isCenterDown==true){$$.global.centerSelectedObj.object.onCenterUp($$.global.centerSelectedObj,a)}}$$.global.canvasContainerDom.addEventListener("click",onDocumentMouseClick);$$.global.canvasContainerDom.addEventListener("mousemove",onDocumentMouseMove);$$.global.canvasContainerDom.addEventListener("mousedown",onMouseDownOrTouchStart);$$.global.canvasContainerDom.addEventListener("mouseup",onMouseUpOrTouchEnd);$$.global.canvasContainerDom.addEventListener("touchstart",onMouseDownOrTouchStart);$$.global.canvasContainerDom.addEventListener("touchend",onMouseUpOrTouchEnd)};this.animate=function(){requestAnimationFrame($$.animate);if($$.global.settings.renderPause){return}if($$.global.settings.resize){$$.resize()}$$.worldActions();for(var i in $$.actionInjections){if($$.actionInjections[i]instanceof Function==true)$$.actionInjections[i]()}if($$.global.settings.raycaster){updateRaycaster()}if($$.global.settings.vr){if(!$$.global.vrEffect){$$.global.vrEffect=new THREE.StereoEffect($$.global.renderer)}$$.global.renderer.render($$.global.world,$$.global.camera);$$.global.vrEffect.render($$.global.world,$$.global.camera)}else{$$.global.renderer.render($$.global.world,$$.global.camera)}if($$.global.controls){$$.global.controls.update()}};this.actionInjections=[];this.worldActions=function(){};this.extends=function(e,f,g){var h=extend(e,f,g);function extend(a,b,c){var d=true;if(c===false){d=false}if(b instanceof Array){for(var i=0,len=b.length;i<len;i++)extend(a,b[i],d)}for(var i in b){if(d||!(i in a)){a[i]=b[i]}}return a}for(var i in f){delete h[i]}return h};this.global.RESOURCE={textures:{},models:{},sounds:{},fonts:{},unloadedSource:{textures:[],models:[],sounds:[],fonts:[]}};this.global.loadingManager=new THREE.LoadingManager();this.global.loadingManager.onProgress=function(a,b,c){$$.onProgress(a,b,c);if(b==c){q=true;if(q&&p==0){if($$.onLoadComplete){$$.onLoadComplete()}}}};this.onProgress=function(){};this.onLoadComplete=function(){};this.loadTexture=function(b){q=false;var c=new THREE.TextureLoader(this.global.loadingManager);for(let i in b){c.load(b[i],function(a){$$.global.RESOURCE.textures[b[i]]=a},function(a){},function(a){$$.global.RESOURCE.unloadedSource.textures.push(b[i]);console.log(b[i]+" is not found")})}};this.loadCubeTexture=function(b,c){q=false;var d=new THREE.CubeTextureLoader(this.global.loadingManager);d.load(c,function(a){console.log(a)$$.global.RESOURCE.textures[b]=a},function(a){},function(a){console.log(a)$$.global.RESOURCE.unloadedSource.textures.push(c[i]);console.log(b+" is not found")})};var p=0;var q=true;this.loadSound=function(b){var c=new THREE.AudioLoader(this.global.loadingManager);for(let i in b){p++;c.load(b[i],function(a){$$.global.RESOURCE.sounds[b[i]]=a;p--;if(q&&p==0){if($$.onLoadComplete){$$.onLoadComplete()}}},function(a){},function(a){$$.global.RESOURCE.unloadedSource.sounds.push(b[i]);console.log(b[i]+" is not found")})}};this.loadFont=function(c){q=false;var d=new THREE.FontLoader(this.global.loadingManager);var e=new THREE.TTFLoader(this.global.loadingManager);for(let i in c){var f=c[i];if(f.lastIndexOf(".json")==f.length-5){d.load(c[i],function(a){$$.global.RESOURCE.fonts[c[i]]=a},function(a){},function(a){$$.global.RESOURCE.unloadedSource.textures.push(c[i]);console.log(c[i]+" is not found")})}else{e.load(c[i],function(a){var b=new THREE.Font(a);$$.global.RESOURCE.fonts[c[i]]=b},function(a){},function(a){$$.global.RESOURCE.unloadedSource.textures.push(c[i]);console.log(c[i]+" is not found")})}}};this.openFullScreen=function(){var a=$$.global.canvasContainerDom;$$.global.settings.isFullScreem=true;if(a.requestFullscreen){a.requestFullscreen()}else if(a.msRequestFullscreen){a.msRequestFullscreen()}else if(a.mozRequestFullScreen){a.mozRequestFullScreen()}else if(a.webkitRequestFullscreen){a.webkitRequestFullscreen()}else{$$.global.settings.isFullScreem=false}return $$.global.settings.isFullScreem};this.closeFullScreen=function(){var a=document;$$.global.settings.isFullScreem=false;if(a.exitFullscreen){a.exitFullscreen()}else if(a.mozCancelFullScreen){a.mozCancelFullScreen()}else if(a.webkitExitFullScreen){a.webkitExitFullScreen()}else if(a.msExitFullscreen){a.msExitFullscreen()}else if(a.webkitCancelFullScreen){a.webkitCancelFullScreen()}if(a.webkitExitFullScreen){a.webkitCancelFullScreen()}return $$.global.settings.isFullScreem};this.toggleFullScreen=function(){if($$.global.settings.isFullScreem){this.closeFullScreen()}else{this.openFullScreen()}};this.groups={};this.createGroup=function(a){if($$.groups[a]){return $$.groups[a]}var g=new $$.ThreeGroup(a);$$.groups[a]=g;return g};this.removeGroup=function(a){if($$.groups[a]){var b=$$.groups[a].children;delete $$.groups[a];return b}return[]};this.global.mouse=new THREE.Vector2();this.global.mouse.x=NaN;this.global.mouse.y=NaN;this.global.raycaster=new THREE.Raycaster();this.global.centerRaycaster=new THREE.Raycaster();this.global.selectedObj=null;this.global.centerSelectedObj=null;function updateMouseRaycaster(a){$$.global.raycaster.setFromCamera($$.global.mouse,$$.global.camera);var b=$$.global.raycaster.intersectObjects($$.global.world.children,true);var c;for(var i=0;i<b.length;i++){if(b[i].object.isPenetrated){continue}else{c=b[i];break}}if(c){if(($$.global.selectedObj==null)||($$.global.selectedObj.object.uuid!=c.object.uuid)){if($$.global.selectedObj&&$$.global.selectedObj.object.uuid!=c.object.uuid&&!a){if($$.global.selectedObj.object.onLeave){$$.global.selectedObj.object.onLeave($$.global.selectedObj)}}$$.global.selectedObj=c;if($$.global.selectedObj.object.onEnter&&!a){$$.global.selectedObj.object.onEnter($$.global.selectedObj)}}else{$$.global.selectedObj=c}}else{if($$.global.selectedObj){if($$.global.selectedObj.object.onLeave){$$.global.selectedObj.object.onLeave($$.global.selectedObj)}$$.global.selectedObj=null}}}function updateCenterRaycaster(){var a=new THREE.Vector2(0,0);$$.global.centerRaycaster.setFromCamera(a,$$.global.camera);var b=$$.global.centerRaycaster.intersectObjects($$.global.world.children);var c;for(var i=0;i<b.length;i++){if(b[i].object.isPenetrated){continue}else{c=b[i];break}}if(c){if(($$.global.centerSelectedObj==null)||($$.global.centerSelectedObj.object.uuid!=c.object.uuid)){if($$.global.centerSelectedObj&&$$.global.centerSelectedObj.object.uuid!=c.object.uuid){if($$.global.centerSelectedObj.object.onCenterLeave){$$.global.centerSelectedObj.object.onCenterLeave($$.global.centerSelectedObj)}}$$.global.centerSelectedObj=c;if($$.global.centerSelectedObj.object.onCenterEnter){$$.global.centerSelectedObj.object.onCenterEnter($$.global.centerSelectedObj)}}else{$$.global.centerSelectedObj=c}}else{if($$.global.centerSelectedObj){if($$.global.centerSelectedObj.object.onCenterLeave){$$.global.centerSelectedObj.object.onCenterLeave($$.global.centerSelectedObj)}$$.global.centerSelectedObj=null}}}function updateRaycaster(){updateMouseRaycaster();updateCenterRaycaster()}this.ThreeGroup=function(b){this.name=b;this.children=[];this.remove=function(a){for(var i in this.children){if(a==this.children[i]){this.splice(i,1);return}}};this.push=function(a){for(var i in this.children){if(a==this.children[i]){return i}}this.children.push(a);return i}};this.get=function(a,b){var c=a.split('=');var d=c[1];c=c[0];var e=null,res=[];if(b){if(typeof b=="string"){e=$$.groups[b];if(e){}else{return[]}}else if(typeof b=="object"){e=b.children}}else{e=$$.global.world.children}if(e){if(c=="id"){for(var i=0;i<e.length;i++){if(e[i].id==d){return e[i]}}}else{for(var i=0;i<e.length;i++){if(e[i][c]==d){res.push(e[i])}}return res}}return[]};this.createSkybox=function(f,g){var h=new THREE.CubeTexture([]);h.format=THREE.RGBFormat;var i=new THREE.ImageLoader();i.load(f,function(d){var e=function(x,y){var a=1024;var b=document.createElement('canvas');b.width=a;b.height=a;var c=b.getContext('2d');c.drawImage(d,-x*a,-y*a);return b};h.images[0]=e(2,1);h.images[1]=e(0,1);h.images[2]=e(1,0);h.images[3]=e(1,2);h.images[4]=e(1,1);h.images[5]=e(3,1);h.needsUpdate=true});var j=THREE.ShaderLib.cube;j.uniforms.tCube.value=h;var k=new THREE.ShaderMaterial({fragmentShader:j.fragmentShader,vertexShader:j.vertexShader,uniforms:j.uniforms,depthWrite:false,side:THREE.BackSide});var l=new THREE.Mesh(new THREE.BoxGeometry(g||1000000,g||1000000,g||1000000),k);scene.add(l);return l};this.createSkydome=function(a,b){var c=new THREE.SphereGeometry(b||1000000,25,25);var d=$$.global.RESOURCE.textures[a]||THREE.ImageUtils.loadTexture(a);var e=new THREE.MeshBasicMaterial({map:d,});var f=new THREE.Mesh(c,e);f.material.side=THREE.BackSide;scene.add(f);return f};this.createSea=function(b){b=$$.extends({},[$$.global.settings.sea,b]);if($$.global.RESOURCE.textures[b.texture]){waterNormals=$$.global.RESOURCE.textures[b.texture];waterNormals.wrapS=waterNormals.wrapT=THREE.RepeatWrapping;water=new THREE.Water(renderer,camera,scene,{textureWidth:waterNormals.image.width,textureHeight:waterNormals.image.height,waterNormals:waterNormals,alpha:b.alpha,waterColor:b.color,});mirrorMesh=new THREE.Mesh(new THREE.PlaneBufferGeometry(b.width,b.height),water.material);mirrorMesh.add(water);mirrorMesh.rotation.x=-Math.PI*0.5;scene.add(mirrorMesh);water.waterMesh=mirrorMesh;return water}else{var c=new THREE.TextureLoader();c.load(b.texture,function(a){$$.global.RESOURCE.textures[b.texture]=a;waterNormals=a;waterNormals.wrapS=waterNormals.wrapT=THREE.RepeatWrapping;water=new THREE.Water(renderer,camera,scene,{textureWidth:waterNormals.image.width,textureHeight:waterNormals.image.height,waterNormals:waterNormals,alpha:b.alpha,waterColor:b.color,});mirrorMesh=new THREE.Mesh(new THREE.PlaneBufferGeometry(b.width,b.height),water.material);mirrorMesh.add(water);mirrorMesh.rotation.x=-Math.PI*0.5;scene.add(mirrorMesh);water.waterMesh=mirrorMesh;$$.actionInjections.push(function(){water.material.uniforms.time.value+=1.0/60.0;water.render()});return water},function(a){},function(a){$$.global.RESOURCE.unloadedSource.textures.push(arr[i]);console.log(arr[i]+" is not found")})}};this.subWorlds={getCurrentSubWorld:function(){for(var i in $$.subWorlds){if($$.subWorlds[i].isCurrent){return $$.subWorlds[i]}}},getSubWorldByName:function(a){for(var i in $$.subWorlds){if($$.subWorlds[i].name==a){return $$.subWorlds[i]}}}};this.SubWorld=function(c,d){this.name=c.name||"";this.id=$$.rndString(16);this.scene=new THREE.Scene();this.camera="";var e=$$.extends({},[$$.global.settings.camera,d]);if(e.type!="OrthographicCamera"){this.camera=new THREE.PerspectiveCamera(e.fov,e.aspect,e.near,e.far)}else{this.camera=new THREE.OrthographicCamera(e.left,e.right,e.top,e.bottom,e.near,e.far)}this.actionInjections=[];renderTargetParameters={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat,stencilBuffer:false};this.clearColor=c.clearColor;this.fbo=new THREE.WebGLRenderTarget($$.getWorldWidth(),$$.getWorldHeight(),renderTargetParameters);this.isResize=c.resize==null?true:c.resize;this.resize=function(){var a=$$.getWorldWidth();var b=$$.getWorldHeight();if(this.camera.type=="PerspectiveCamera"){this.camera.aspect=a/b;this.camera.updateProjectionMatrix()}else{this.camera.left=-a/2;this.camera.right=a/2;this.camera.top=b/2;this.camera.bottom=-b/2}$$.global.renderer.setSize(a,b);if($$.global.settings.vr&&$$.global.vrEffect){$$.global.vrEffect.setSize(a,b)}};this.update=function(a){if(this.isResize){this.resize()}for(var i=0;i<this.actionInjections.length;i++){this.actionInjections[i]()}if(a){$$.global.renderer.render(this.scene,this.camera,this.fbo,true)}else{$$.global.renderer.render(this.scene,this.camera)}};this.isCurrent=false;this.toMain=function(){$$.global.world=this.scene;$$.global.camera=this.camera;$$.actionInjections=this.actionInjections;$$.global.renderer.setClearColor(this.clearColor);$$.global.controls=this.controls;for(var i in $$.subWorlds){if($$.subWorlds[i].isCurrent){$$.subWorlds[i].isCurrent=false;if($$.subWorlds[i].controls){$$.subWorlds[i].controls.enabledBefore=$$.subWorlds[i].controls.enabled;$$.subWorlds[i].controls.enabled=false}}}this.isCurrent=true;if(this.controls){this.controls.enabled=this.controls.enabledBefore}};$$.subWorlds[this.id]=this};this.Transition=function(j,k,l){var m=function(d,e,f,g){var h={scene:d,camera:e,actionInjections:f};renderTargetParameters={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat,stencilBuffer:false};h.fbo=new THREE.WebGLRenderTarget($$.getWorldWidth(),$$.getWorldHeight(),renderTargetParameters);h.clearColor=g;h.update=function(a){if($$.global.settings.resize){var b=$$.getWorldWidth();var c=$$.getWorldHeight();if(h.camera.type=="PerspectiveCamera"){h.camera.aspect=b/c;h.camera.updateProjectionMatrix()}else{h.camera.left=-b/2;h.camera.right=b/2;h.camera.top=c/2;h.camera.bottom=-c/2}$$.global.renderer.setSize(b,c)}$$.global.renderer.setClearColor(h.clearColor);if(a)$$.global.renderer.render(h.scene,h.camera,h.fbo,true);else{$$.global.renderer.render(h.scene,h.camera)}};return h};var n=$$.extends({},[{"useTexture":true,"transition":0,"transitionSpeed":10,"texture":5,"loopTexture":true,"animateTransition":true,"textureThreshold":0.3},k]);var o=m($$.global.world,$$.global.camera,$$.actionInjections,$$.global.renderer.getClearColor().clone());this.scene=new THREE.Scene();this.cameraOrtho=$$.createCamera({type:"OrthographicCamera",near:-10,far:10});this.texture=l;this.quadmaterial=new THREE.ShaderMaterial({uniforms:{tDiffuse1:{value:null},tDiffuse2:{value:null},mixRatio:{value:0.0},threshold:{value:0.1},useTexture:{value:1},tMixTexture:{value:this.texture}},vertexShader:["varying vec2 vUv;","void main() {","vUv = vec2( uv.x, uv.y );","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float mixRatio;","uniform sampler2D tDiffuse1;","uniform sampler2D tDiffuse2;","uniform sampler2D tMixTexture;","uniform int useTexture;","uniform float threshold;","varying vec2 vUv;","void main() {","vec4 texel1 = texture2D( tDiffuse1, vUv );","vec4 texel2 = texture2D( tDiffuse2, vUv );","if (useTexture==1) {","vec4 transitionTexel = texture2D( tMixTexture, vUv );","float r = mixRatio * (1.0 + threshold * 2.0) - threshold;","float mixf=clamp((transitionTexel.r - r)*(1.0/threshold), 0.0, 1.0);","gl_FragColor = mix( texel1, texel2, mixf );","} else {","gl_FragColor = mix( texel2, texel1, mixRatio );","}","}"].join("\n")});$$.global.world=this.scene;$$.global.camera=this.cameraOrtho;quadgeometry=new THREE.PlaneBufferGeometry($$.getWorldWidth(),$$.getWorldHeight());this.quad=new THREE.Mesh(quadgeometry,this.quadmaterial);this.scene.add(this.quad);this.sceneA=j;this.sceneB=o;this.quadmaterial.uniforms.tDiffuse1.value=j.fbo.texture;this.quadmaterial.uniforms.tDiffuse2.value=o.fbo.texture;this.needChange=false;this.setTextureThreshold=function(a){this.quadmaterial.uniforms.threshold.value=a};this.useTexture=function(a){this.quadmaterial.uniforms.useTexture.value=a?1:0};this.setTexture=function(i){this.quadmaterial.uniforms.tMixTexture.value=this.texture};this.render=function(){var a=arguments.callee.owner;if($$.global.settings.resize){var b=$$.getWorldWidth();var c=$$.getWorldHeight();a.cameraOrtho.left=-b/2;a.cameraOrtho.right=b/2;a.cameraOrtho.top=c/2;a.cameraOrtho.bottom=-c/2}if(n.animateTransition){n.transition+=0.001*n.transitionSpeed}a.quadmaterial.uniforms.mixRatio.value=Math.min(n.transition,1);if(n.transition===0){a.sceneB.update(false)}else if(n.transition>=1){a.sceneA.update(true);for(var i=0;i<$$.actionInjections.length;i++){if($$.actionInjections[i]==arguments.callee){$$.actionInjections.splice(i,1)}}a.sceneA.toMain()}else{$$.global.renderer.setClearColor(a.sceneB.clearColor);a.sceneB.update(true);$$.global.renderer.setClearColor(a.sceneA.clearColor);a.sceneA.update(true);$$.global.renderer.render(a.scene,a.cameraOrtho,null,true)}};this.render.owner=this};this.rndString=function(a){if(a<=0){return""}a=a-1||31;　　var b='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';　　var c=b.length+1;　　var d=b.charAt(Math.floor(Math.random()*(c-10)));for(i=0;i<a;i++){　　　　d+=b.charAt(Math.floor(Math.random()*c));　　}　　return d};this.rndInt=function(a){return Math.floor(Math.random()*a)};this.global.settings={camera:{type:"PerspectiveCamera",fov:90,aspect:this.getWorldWidth()/this.getWorldHeight(),near:1,far:10000,left:-this.getWorldWidth()/2,right:this.getWorldWidth()/2,top:this.getWorldHeight()/2,bottom:-this.getWorldHeight()/2,},render:{alpha:false,antialias:true,clearColor:0x000000,depth:true,logarithmicDepthBuffer:false,precision:"highp",premultipliedAlpha:false,preserveDrawingBuffer:false,stencil:true,},sea:{alpha:1,color:0x001e0f,width:100000,height:100000},raycaster:true,resize:true,renderPause:false,vr:false,showLoadingProgress:false,isFullScreem:false}};var $$=new threeQuery();$$.Component={drawTextImage:function(a,b){var c={fontSize:30,fontFamily:"Courier New",color:"white",textAlign:5,backgroundColor:"red",width:1,height:1,lineHeight:30,x:0,y:0};var d=a.split("\n");var e=0;for(var i in d){if(e<d[i].length){e=d[i].length}}var f=$$.extends({},[c,b]);if(!b.width){while(f.width<e*f.fontSize){f.width*=2}}if(!b.height){var g=d.length*f.lineHeight;while(f.height<g){f.height*=2}}var h=document.createElement("canvas");h.width=f.width;h.height=f.height;var j=h.getContext("2d");j.fillStyle=f.backgroundColor;j.fillRect(0,0,f.width,f.height);j.font=f.fontSize+"px "+f.fontFamily;j.fillStyle=f.color;var x=0,y=0;for(var i in d){j.fillText(d[i],f.x,f.y+(f.lineHeight*i+f.lineHeight))}return h},Timer:function(a,b){this.actionInjections=b?b.actionInjections:$$.actionInjections;var c={id:"",life:1000,duration:1000,onStart:function(){console.log("timer start")},onRepeat:function(){console.log("repeat")},onEnd:function(){console.log("timer end")}};this.options=$$.extends({},[c,a]);this.id=a.id;this.life=a.life;this.duration=a.duration;this.onStart=a.onStart||function(){console.log("timer start")};this.onRepeat=a.onRepeat||function(){console.log("timer repeat")};this.onEnd=a.onEnd||function(){console.log("timer end")};this.lastTime;this.nowTime;this.elapsedTime=0;this.durationTmp=0;this.start=function(){this.lastTime=this.nowTime=performance.now();this.onStart();this.actionInjections.push(this.update)};let thisObj=this;this.update=function(){thisObj.lastTime=thisObj.nowTime;thisObj.nowTime=performance.now();thisObj.elapsedTime=thisObj.nowTime-thisObj.lastTime;thisObj.life-=thisObj.elapsedTime;if(thisObj.life<=0){thisObj.onEnd();for(var i in thisObj.actionInjections){if(thisObj.update==thisObj.actionInjections[i]){thisObj.actionInjections.splice(i,1);break}}return}thisObj.durationTmp+=thisObj.elapsedTime;if(thisObj.durationTmp>=thisObj.duration){thisObj.durationTmp-=thisObj.duration;thisObj.onRepeat()}}},createBullet:function(a,b){var c=$$.controls.getObject().position;var d=$$.global.centerRaycaster.ray.direction;var e={speed:3,life:10000,position:new THREE.Vector3(c.x,c.y,c.z),direction:new THREE.Vector3(d.x,d.y,d.z)};b=$$.extends({},[e,b]);a.lookAt(b.direction);a.position.x=b.position.x;a.position.y=b.position.y;a.position.z=b.position.z;a.lifeStart=new Date().getTime();a.life=b.life;$$.global.world.add(a);$$.actionInjections.push(function(){a.position.x+=b.direction.x*b.speed;a.position.y+=b.direction.y*b.speed;a.position.z+=b.direction.z*b.speed;if(a.life<=new Date().getTime()-a.lifeStart){$$.global.world.remove(a);for(var i in $$.actionInjections){if($$.actionInjections[i]==arguments.callee){$$.actionInjections.splice(i,1)}}}})},createSkydome:function(a,b,c){var d=new THREE.SphereGeometry(b||1000000,25,25);var e=$$.global.RESOURCE.textures[a]||THREE.ImageUtils.loadTexture(a);var f=new THREE.MeshBasicMaterial({map:e,});var g=new THREE.Mesh(d,f);g.material.side=THREE.BackSide;if(c){c.scene.add(g)}else{$$.global.world.add(g)}return g},createSkybox:function(f,g,h){var i=new THREE.CubeTexture([]);i.format=THREE.RGBFormat;var j=new THREE.ImageLoader();j.load(f,function(d){var e=function(x,y){var a=1024;var b=document.createElement('canvas');b.width=a;b.height=a;var c=b.getContext('2d');c.drawImage(d,-x*a,-y*a);return b};i.images[0]=e(2,1);i.images[1]=e(0,1);i.images[2]=e(1,0);i.images[3]=e(1,2);i.images[4]=e(1,1);i.images[5]=e(3,1);i.needsUpdate=true});var k=THREE.ShaderLib.cube;k.uniforms.tCube.value=i;var l=new THREE.ShaderMaterial({fragmentShader:k.fragmentShader,vertexShader:k.vertexShader,uniforms:k.uniforms,depthWrite:false,side:THREE.BackSide});var m=new THREE.Mesh(new THREE.BoxGeometry(g||1000000,g||1000000,g||1000000),l);if(h){h.scene.add(m)}else{$$.global.world.add(m)}return m},createSea:function(b,c){c=c||{scene:$$.global.world,camera:$$.global.camera,renderer:$$.global.renderer};b=$$.extends({},[$$.global.settings.sea,b]);if($$.global.RESOURCE.textures[b.texture]){waterNormals=$$.global.RESOURCE.textures[b.texture];waterNormals.wrapS=waterNormals.wrapT=THREE.RepeatWrapping;water=new THREE.Water($$.global.renderer,c.camera,c.scene,{textureWidth:waterNormals.image.width,textureHeight:waterNormals.image.height,waterNormals:waterNormals,alpha:b.alpha,waterColor:b.color,});mirrorMesh=new THREE.Mesh(new THREE.PlaneBufferGeometry(b.width,b.height),water.material);mirrorMesh.add(water);mirrorMesh.rotation.x=-Math.PI*0.5;c.scene.add(mirrorMesh);water.waterMesh=mirrorMesh;if(c){c.actionInjections.push(function(){water.material.uniforms.time.value+=1.0/60.0;water.render()})}else{$$.actionInjections.push(function(){water.material.uniforms.time.value+=1.0/60.0;water.render()})}return water}else{var d=new THREE.TextureLoader();d.load(b.texture,function(a){$$.global.RESOURCE.textures[b.texture]=a;waterNormals=a;waterNormals.wrapS=waterNormals.wrapT=THREE.RepeatWrapping;water=new THREE.Water($$.global.renderer,c.camera,c.scene,{textureWidth:waterNormals.image.width,textureHeight:waterNormals.image.height,waterNormals:waterNormals,alpha:b.alpha,waterColor:b.color,});mirrorMesh=new THREE.Mesh(new THREE.PlaneBufferGeometry(b.width,b.height),water.material);mirrorMesh.add(water);mirrorMesh.rotation.x=-Math.PI*0.5;c.scene.add(mirrorMesh);water.waterMesh=mirrorMesh;if(c){c.actionInjections.push(function(){water.material.uniforms.time.value+=1.0/60.0;water.render()})}else{$$.actionInjections.push(function(){water.material.uniforms.time.value+=1.0/60.0;water.render()})}return water},function(a){},function(a){$$.global.RESOURCE.unloadedSource.textures.push(arr[i]);console.log(arr[i]+" is not found")})}}};$$.Controls={createOrbitControls:function(a,b){a=a?a:{};a=$$.extends({},[{noZoom:true,noPan:true,rotateUp:0,minDistance:0,maxDistance:Infinity,zoomSpeed:1.0,noRotate:false,rotateSpeed:1.0,keyPanSpeed:7.0,autoRotate:false,autoRotateSpeed:2.0,minPolarAngle:0,maxPolarAngle:Math.PI,},a]);var c=b?b.camera:$$.global.camera;var d=$$.global.canvasDom;var e=new THREE.OrbitControls(c,d);e.rotateUp(a.rotateUp);e.target.set(c.position.x+0.1,c.position.y,c.position.z);e.noZoom=a.noZoom;e.noPan=a.noPan;e.minDistance=a.minDistance;e.maxDistance=a.maxDistance;e.zoomSpeed=a.zoomSpeed;e.noRotate=a.noRotate;e.rotateSpeed=a.rotateSpeed;e.keyPanSpeed=a.keyPanSpeed;e.autoRotate=a.autoRotate;e.autoRotateSpeed=a.autoRotateSpeed;e.minPolarAngle=a.minPolarAngle;e.maxPolarAngle=a.maxPolarAngle;if(b){b.controls=e;b.controls.enabledBefore=e.enabled}else{$$.global.controls=e}return e},createTrackBallControls:function(a,b){if(!a){a={}}var c=b?b.camera:$$.global.camera;controls=new THREE.TrackballControls(c);controls.rotateSpeed=a.rotateSpeed||1;controls.minDistance=a.minDistance||1000;controls.maxDistance=a.maxDistance||1000;controls.zoomSpeed=a.zoomSpeed||1;controls.panSpeed=a.panSpeed||1;controls.noZoom=a.noZoom||false;controls.noPan=a.noPan||false;controls.enabled=a.enabled==null?true:a.enabled;controls.dynamicDampingFactor=a.dynamicDampingFactor||0.3;controls.staticMoving=a.staticMoving||false;if(b){b.controls=controls;b.controls.enabledBefore=controls.enabled}else{$$.global.controls=controls}return controls},createDeviceOrientationControls:function(){var a=new THREE.DeviceOrientationControls($$.global.camera,true);a.connect();a.update();$$.global.controls=a;return a},createPointerLockControls:function(){var a=new THREE.PointerLockControls($$.global.camera);$$.global.controls=a;scene.add(a.getObject());a.controlsEnabled=true;a.enabled=true;a.update=function(){};return a},createFirstCharacterControls:function(d,e){if(d){if(d.speed){d.speed.x=d.speed.x!=null?d.speed.x:1;d.speed.z=d.speed.z!=null?d.speed.z:1;d.speed.y=d.speed.y!=null?d.speed.y:200}else{d.speed=new THREE.Vector3(100,200,100)}d.gravity=d.gravity!=null?d.gravity:10;d.tall=d.tall!=null?d.tall:10;if(d.acceleration){d.acceleration.x=d.acceleration.x!=null?d.acceleration.x:1;d.acceleration.z=d.acceleration.z!=null?d.acceleration.z:1}else{d.acceleration=new THREE.Vector3(1,0,1)}}var f=new THREE.PointerLockControls($$.global.camera);$$.global.controls=f;scene.add(f.getObject());var g='pointerLockElement'in document||'mozPointerLockElement'in document||'webkitPointerLockElement'in document;if(g){var h=document.body;var i=function(a){if(document.pointerLockElement===h||document.mozPointerLockElement===h||document.webkitPointerLockElement===h){f.controlsEnabled=true;f.enabled=true;e.style.display='none'}else{f.enabled=false;e.style.display='-webkit-box';e.style.display='-moz-box';e.style.display='box'}};var j=function(a){e.style.display='-webkit-box';e.style.display='-moz-box';e.style.display='box'};document.addEventListener('pointerlockchange',i,false);document.addEventListener('mozpointerlockchange',i,false);document.addEventListener('webkitpointerlockchange',i,false);document.addEventListener('pointerlockerror',j,false);document.addEventListener('mozpointerlockerror',j,false);document.addEventListener('webkitpointerlockerror',j,false);e.addEventListener('click',function(b){e.style.display='none';h.requestPointerLock=h.requestPointerLock||h.mozRequestPointerLock||h.webkitRequestPointerLock;if(/Firefox/i.test(navigator.userAgent)){var c=function(a){if(document.fullscreenElement===h||document.mozFullscreenElement===h||document.mozFullScreenElement===h){document.removeEventListener('fullscreenchange',c);document.removeEventListener('mozfullscreenchange',c);h.requestPointerLock()}};document.addEventListener('fullscreenchange',c,false);document.addEventListener('mozfullscreenchange',c,false);h.requestFullscreen=h.requestFullscreen||h.mozRequestFullscreen||h.mozRequestFullScreen||h.webkitRequestFullscreen;h.requestFullscreen()}else{h.requestPointerLock()}},false)}else{e.innerHTML='Your browser doesn\'t seem to support Pointer Lock API'}f.controlsEnabled=false;f.moveForward=false;f.moveBackward=false;f.moveLeft=false;f.moveRight=false;f.canJump=true;f.prevTime=performance.now();f.velocity=new THREE.Vector3(0,0,0);if(d&&d.keymove){document.addEventListener('keydown',function(a){switch(a.keyCode){case 38:case 87:$$.global.controls.moveForward=true;break;case 37:case 65:$$.global.controls.moveLeft=true;break;case 40:case 83:$$.global.controls.moveBackward=true;break;case 39:case 68:$$.global.controls.moveRight=true;break;case 32:if($$.global.controls.canJump===true){$$.global.controls.velocity.y+=d.speed.y};$$.global.controls.canJump=false;break}},false);document.addEventListener('keyup',function(a){switch(a.keyCode){case 38:case 87:$$.global.controls.moveForward=false;break;case 37:case 65:$$.global.controls.moveLeft=false;break;case 40:case 83:$$.global.controls.moveBackward=false;break;case 39:case 68:$$.global.controls.moveRight=false;break}},false)}f.prevTime=performance.now();f.update=function(){if($$.global.controls.enabled){$$.global.controls.time=performance.now();var a=($$.global.controls.time-$$.global.controls.prevTime)/1000;$$.global.controls.velocity.x-=$$.global.controls.velocity.x*d.acceleration.x*a;$$.global.controls.velocity.z-=$$.global.controls.velocity.z*d.acceleration.z*a;$$.global.controls.velocity.y-=d.gravity*100.0*a;if($$.global.controls.moveForward)$$.global.controls.velocity.z-=d.speed.z*a;if($$.global.controls.moveBackward)$$.global.controls.velocity.z+=d.speed.z*a;if($$.global.controls.moveLeft)$$.global.controls.velocity.x-=d.speed.x*a;if($$.global.controls.moveRight)$$.global.controls.velocity.x+=d.speed.x*a;$$.global.controls.getObject().translateX($$.global.controls.velocity.x*a);$$.global.controls.getObject().translateY($$.global.controls.velocity.y*a);$$.global.controls.getObject().translateZ($$.global.controls.velocity.z*a);if($$.global.controls.getObject().position.y<d.tall){$$.global.controls.velocity.y=0;$$.global.controls.getObject().position.y=d.tall;$$.global.controls.canJump=true}$$.global.controls.prevTime=$$.global.controls.time}};return f},};$$.Move={Linear:function(c,d,e){this.obj=c;this.speedRate=d;this.targetPosition=e;this.direction={x:this.targetPosition.x-this.obj.position.x,y:this.targetPosition.y-this.obj.position.y,z:this.targetPosition.z-this.obj.position.z,};var f=$$.unitVector(this.direction);this.speed={x:f.x*d,y:f.y*d,z:f.z*d,};this.update=function(){var a=arguments.callee.owner;a.direction={x:a.targetPosition.x-a.obj.position.x,y:a.targetPosition.y-a.obj.position.y,z:a.targetPosition.z-a.obj.position.z,};var b=vecLength(a.direction);if(b<a.speedRate){a.obj.position.x=a.targetPosition.x;a.obj.position.y=a.targetPosition.y;a.obj.position.z=a.targetPosition.z;a.destroy()}else{a.obj.position.x+=a.speed.x;a.obj.position.y+=a.speed.y;a.obj.position.z+=a.speed.z}};this.update.owner=this;this.destroy=function(){for(var i=0;i<$$.actionInjections.length;i++){if($$.actionInjections[i]==this.update){$$.actionInjections.splice(i,1);break}}}},Surround:function(g,h,j,k){this.angle=0;this.speedRate=j;this.mother=g;this.child=h;this.vVect=k;this.radius=$$.vecLength({x:this.child.position.x-this.mother.position.x,y:this.child.position.y-this.mother.position.y,z:this.child.position.z-this.mother.position.z});this.update=function(){var a={x:this.child.position.x-this.mother.position.x,y:this.child.position.y-this.mother.position.y,z:this.child.position.z-this.mother.position.z};var b=$$.vecLength(a);a.x=a.x*this.radius/b;a.y=a.y*this.radius/b;a.z=a.z*this.radius/b;var c=$$.crossMulti(a,k);var d=$$.vecLength(c);c.x=c.x*j/d;c.y=c.y*j/d;c.z=c.z*j/d;h.position.x+=c.x;h.position.y+=c.y;h.position.z+=c.z;var e={x:this.child.position.x-this.mother.position.x,y:this.child.position.y-this.mother.position.y,z:this.child.position.z-this.mother.position.z};var f=$$.vecLength(e);e.x=e.x*this.radius/f;e.y=e.y*this.radius/f;e.z=e.z*this.radius/f;this.child.position.x=this.mother.position.x+e.x;this.child.position.y=this.mother.position.y+e.y;this.child.position.z=this.mother.position.z+e.z};this.destroy=function(){for(var i=0;i<$$.actionInjections.length;i++){if($$.actionInjections[i]==this.update){$$.actionInjections.splice(i,1);break}}}},RelateToCamera:function(b,c,d){if(!d){this.camera=$$.global.camera}else{this.camera=d.camera}this.obj=b;this.isFaceToCamera=c;this.absVec={x:b.position.x-this.camera.position.x,y:b.position.y-this.camera.position.y,z:b.position.z-this.camera.position.z};console.log(this.absVec);this.update=function(){var a=arguments.callee.owner;a.obj.position.x=a.camera.position.x+a.absVec.x;a.obj.position.y=a.camera.position.y+a.absVec.y;a.obj.position.z=a.camera.position.z+a.absVec.z;if(c){a.obj.lookAt(a.camera.position)}};this.update.owner=this;this.destroy=function(){for(var i=0;i<$$.actionInjections.length;i++){if($$.actionInjections[i]==this.update){$$.actionInjections.splice(i,1);break}}}}};$$.crossMulti=function(a,b){var c={x:0,y:0,z:0};c.x=a.y*b.z-b.y*a.z;c.y=a.z*b.x-b.z*a.x;c.z=a.x*b.y-b.x*a.y;return c};$$.vecLength=function(a){return Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z)};$$.unitVector=function(a){var b=$$.vecLength(a);a.x/=b;a.y/=b;a.z/=b;return a};$$.Weather={Snow:function(d,e){d=$$.extends({},[{startSpeed:2,endSpeed:10,duration:50,amount:2000,startAmount:500,fallSpeed:2,scale:[10,20],wind:{x:0,y:0,z:0},area:{x:[-2000,2000],y:[-2000,2000],z:[-2000,2000],},swing:{x:2,y:0,z:2}},d]);this.amount=d.amount;this.startAmount=d.startAmount;this.fallSpeed=d.fallSpeed;this.scale=d.scale;this.wind=d.wind;this.swing=d.swing;this.startSpeed=d.startSpeed;this.endSpeed=d.endSpeed;this.duration=d.duration;this.particles=[];this.material=new THREE.SpriteMaterial({map:e,color:0xffffff});this.onStartEnd=function(){console.log("snow start end")};this.onEndEnd=function(){console.log("snow end end")};this.area=d.area;function randomRange(a,b){return((Math.random()*(b-a))+a)}function rndInt(n){return Math.floor(Math.random()*n)}for(i=0;i<this.startAmount;i++){var f=new THREE.Sprite(this.material);var g=randomRange(this.scale[0],this.scale[1]);f.position.x=randomRange(this.area.x[0],this.area.x[1]);f.position.y=randomRange(this.area.y[0],this.area.y[1]);f.position.z=randomRange(this.area.z[0],this.area.z[1]);f.scale.x=f.scale.y=f.scale.z=g;f.v=new THREE.Vector3(0,this.wind.y-this.fallSpeed+randomRange(-this.swing.y,this.swing.y),0);f.v.z=(this.wind.z+randomRange(-this.swing.z,this.swing.z));f.v.x=(this.wind.x+randomRange(-this.swing.x,this.swing.x));this.particles.push(f);$$.global.world.add(f)}this.start=function(){var c=new $$.Component.Timer({life:(this.amount-this.startAmount)/this.startSpeed*this.duration,duration:this.duration,onRepeat:function(){for(var i=0;i<this.owner.startSpeed;i++){if(this.owner.particles.length>=this.owner.amount){break}var a=new THREE.Sprite(this.owner.material);var b=randomRange(this.owner.scale[0],this.owner.scale[1]);a.position.x=randomRange(this.owner.area.x[0],this.owner.area.x[1]);a.position.y=this.owner.area.y[1];a.position.z=randomRange(this.owner.area.z[0],this.owner.area.z[1]);a.scale.x=a.scale.y=a.scale.z=b;a.v=new THREE.Vector3(0,this.owner.wind.y-this.owner.fallSpeed+randomRange(-this.owner.swing.y,this.owner.swing.y),0);a.v.z=(this.owner.wind.z+randomRange(-this.owner.swing.z,this.owner.swing.z));a.v.x=(this.owner.wind.x+randomRange(-this.owner.swing.x,this.owner.swing.x));this.owner.particles.push(a);$$.global.world.add(a)}},onEnd:this.onStartEnd});c.owner=this;c.start();$$.actionInjections.push(this.update)}this.end=function(){var b=new $$.Component.Timer({life:(this.amount/this.endSpeed+1)*this.duration,duration:this.duration,onRepeat:function(){for(var i=0;i<this.owner.endSpeed;i++){if(this.owner.particles.length>0){var a=rndInt(this.owner.particles.length);$$.global.world.remove(this.owner.particles[a]);this.owner.particles.splice(a,1)}else{break}}},onEnd:function(){while(this.owner.particles.length){var a=rndInt(this.owner.particles.length);$$.global.world.remove(this.owner.particles[a]);this.owner.particles.splice(a,1)}onEnd:this.owner.onEndEnd}});b.owner=this;b.start();$$.actionInjections.push(this.update)}this.update=function(){var a=arguments.callee.owner;for(var i=0;i<a.particles.length;i++){var b=a.particles[i];var c=b.position;c.add(b.v);if(c.y<a.area.y[0])c.y=a.area.y[1];if(c.x>a.area.x[1])c.x=a.area.x[0];else if(c.x<a.area.x[0])c.x=a.area.x[1];if(c.z>a.area.z[1])c.z=a.area.z[0];else if(c.z<a.area.z[0])c.z=a.area.z[1]}}this.update.owner=this}};$$.Device={getOSInfo:function(){var a=navigator.userAgent,isWindowsPhone=/(?:Windows Phone)/.test(a),isSymbian=/(?:SymbianOS)/.test(a)||isWindowsPhone,isAndroid=/(?:Android)/.test(a),isFireFox=/(?:Firefox)/.test(a),isChrome=/(?:Chrome|CriOS)/.test(a),isTablet=/(?:iPad|PlayBook)/.test(a)||(isAndroid&&!/(?:Mobile)/.test(a))||(isFireFox&&/(?:Tablet)/.test(a)),isPhone=/(?:iPhone)/.test(a)&&!isTablet,isPc=!isPhone&&!isAndroid&&!isSymbian&&!isTablet;return{isTablet:isTablet,isIPhone:isPhone,isAndroid:isAndroid,isPc:isPc}}};$$.sound={}